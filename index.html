<!DOCTYPE html>
<html>
<head>
  <title>Fhenix Battleship</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1 class="title">Fhenix Battleship</h1>
    <!-- Logged In -->
    <div class="grid btn-logged-in">
      <button id="get-user-info" class="btn">Get User Info</button>
      <button id="get-accounts" class="btn">Get Accounts</button>
      <button id="get-balance" class="btn">Get Balance</button>
      <button id="sign-message" class="btn">Sign Message</button>
      <button id="show-wallet" class="btn">Show Wallet</button>
      <button id="logout" class="btn">Logout</button>
      <div class="console" id="console">
        <p id="code" class="code"></p>
      </div>
    </div>

    <!-- Logged Out -->
    <div class="grid btn-logged-out">
      <button id="login" class="btn">Login</button>
    </div>

    <!-- Game container -->
    <div class="game-container">
      <div class="boards-container">
        <div id="player-board" class="board"></div>
        <div id="opponent-board" class="board"></div>
      </div>
      <div class="controls">
        <button id="create-game" class="btn">Create Game</button>
        <input type="number" id="game-id-input" placeholder="Game ID">
        <button id="join-game" class="btn">Join Game</button>
        <button id="place-ships" class="btn">Place Ships</button>
      </div>
      <div id="game-status" class="status"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/base64-js@1.5.1/base64js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal"></script>
  <script src="https://cdn.jsdelivr.net/npm/@web3auth/wallet-services-plugin"></script>
  <script src="https://cdn.jsdelivr.net/npm/@web3auth/ethereum-provider"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@4.1.1/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fhenixjs@0.3.0-alpha.1/dist/fhenix.umd.min.js"></script>

  <script type="module">
  import { ethers } from "../ethers.min.js";
  import { BATTLESHIP_ABI, BATTLESHIP_ADDRESS } from './constants.js';

  let web3auth = null;
  let walletServicesPlugin = null;
  let fhenixClient = null;
  let battleshipContract = null;
  let currentGameId = null;

  const BOARD_SIZE = 10;
  const BOARD_CELLS = BOARD_SIZE * BOARD_SIZE;

  async function init() {
    $(".btn-logged-in").hide();
    $(".game-container").hide();

    const clientId = "BKFLAA4PxFOm-tmlwmXOwC35iB1rLyWAaq7cjUjjz13wCh1zcGJz3JVJKcWdHiKq98QndXv7gUYpP94HoDmB1cg";

    const chainConfig = {
      chainNamespace: "eip155",
      chainId: "0x7a31c7",
      rpcTarget: "https://api.helium.fhenix.zone",
      displayName: "Fhenix Helium Testnet",
      blockExplorerUrl: "https://explorer.helium.fhenix.zone/",
      ticker: "tFHE",
      tickerName: "tFhenix",
    };

    const privateKeyProvider = new window.EthereumProvider.EthereumPrivateKeyProvider({ config: { chainConfig } });
    web3auth = new window.Modal.Web3Auth({
      clientId,
      privateKeyProvider,
      web3AuthNetwork: "sapphire_mainnet",
    });

    walletServicesPlugin = new window.WalletServicesPlugin.WalletServicesPlugin();
    web3auth.addPlugin(walletServicesPlugin);

    await web3auth.initModal();
    
    if (web3auth.connected) {
      onLogin();
    }
  }

  async function onLogin() {
    $(".btn-logged-in").show();
    $(".btn-logged-out").hide();
    $(".game-container").show();

    const provider = new ethers.providers.Web3Provider(web3auth.provider);
    const signer = provider.getSigner();
    battleshipContract = new ethers.Contract(BATTLESHIP_ADDRESS, BATTLESHIP_ABI, signer);

    fhenixClient = new fhenixjs.FhenixClient({ provider });
    const permit = await fhenixjs.getPermit(BATTLESHIP_ADDRESS, provider);
    fhenixClient.storePermit(permit);

    initializeBoards();
  }

  function initializeBoards() {
    const playerBoard = document.getElementById('player-board');
    const opponentBoard = document.getElementById('opponent-board');

    for (let i = 0; i < BOARD_CELLS; i++) {
      const playerCell = document.createElement('div');
      playerCell.classList.add('cell');
      playerBoard.appendChild(playerCell);

      const opponentCell = document.createElement('div');
      opponentCell.classList.add('cell');
      opponentCell.addEventListener('click', () => fireShot(i));
      opponentBoard.appendChild(opponentCell);
    }
  }

  async function createGame() {
    try {
      const tx = await battleshipContract.createGame();
      const receipt = await tx.wait();
      const event = receipt.events.find(e => e.event === 'GameCreated');
      currentGameId = event.args.gameId.toNumber();
      uiConsole(`Game created with ID: ${currentGameId}`);
    } catch (error) {
      uiConsole(`Error: ${error.message}`);
    }
  }

  async function joinGame() {
    const gameId = document.getElementById('game-id-input').value;
    try {
      await battleshipContract.joinGame(gameId);
      currentGameId = gameId;
      uiConsole(`Joined game with ID: ${gameId}`);
    } catch (error) {
      uiConsole(`Error: ${error.message}`);
    }
  }

  async function placeShips() {
    const encryptedBoard = Array(BOARD_CELLS).fill(0);
    for (let i = 0; i < 17; i++) {
      encryptedBoard[i] = await fhenixClient.encrypt(1);
    }
    try {
      await battleshipContract.placeShips(currentGameId, encryptedBoard);
      uiConsole("Ships placed successfully");
    } catch (error) {
      uiConsole(`Error: ${error.message}`);
    }
  }

  async function fireShot(position) {
    try {
      await battleshipContract.fireShot(currentGameId, position);
      uiConsole(`Shot fired at position: ${position}`);
      updateBoards();
    } catch (error) {
      uiConsole(`Error: ${error.message}`);
    }
  }

  async function updateBoards() {
    const signer = (new ethers.providers.Web3Provider(web3auth.provider)).getSigner();
    const playerBoard = await battleshipContract.getShipBoard(currentGameId, await fhenixClient.getPermit(), await signer.getAddress());
    const opponentHitBoard = await battleshipContract.getHitBoard(currentGameId, await signer.getAddress());

    for (let i = 0; i < BOARD_CELLS; i++) {
      const playerCell = document.querySelector(`#player-board .cell:nth-child(${i+1})`);
      const opponentCell = document.querySelector(`#opponent-board .cell:nth-child(${i+1})`);

      if (playerBoard[i] === 1) playerCell.classList.add('ship');
      
      const hitResult = await fhenixClient.decrypt(opponentHitBoard[i]);
      if (hitResult === 1) opponentCell.classList.add('hit');
      else if (hitResult === 0) opponentCell.classList.add('miss');
    }
  }

  function uiConsole(...args) {
    const el = document.querySelector("#console>p");
    if (el) {
      el.innerHTML = JSON.stringify(args || {}, null, 2);
    }
  }

  // Event listeners
  $("#login").click(() => web3auth.connect().then(onLogin));
  $("#logout").click(() => web3auth.logout().then(() => {
    $(".btn-logged-in").hide();
    $(".btn-logged-out").show();
    $(".game-container").hide();
  }));
  $("#get-user-info").click(() => web3auth.getUserInfo().then(uiConsole));
  $("#get-accounts").click(() => web3auth.provider.request({ method: 'eth_accounts' }).then(uiConsole));
  $("#get-balance").click(() => web3auth.provider.request({ method: 'eth_getBalance', params: [web3auth.address, 'latest'] }).then(balance => uiConsole(parseInt(balance, 16))));
  $("#sign-message").click(() => {
    const message = "Hello World";
    web3auth.provider.request({
      method: 'personal_sign',
      params: [message, web3auth.address],
    }).then(uiConsole);
  });
  $("#create-game").click(createGame);
  $("#join-game").click(joinGame);
  $("#place-ships").click(placeShips);

  init();
  </script>
</body>
</html>
